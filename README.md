# Differential Testing for WASM

## Setting up your environment

Run the following command to setup the environment and install all the dependencies listed in `requirements.txt`.
```
./setup_env.sh
```

Set the environment variable with the OpenAI API key. 
```
export OPENAI_API_KEY="<ENTER OPENAI API KEY>"
```

## 1. Extract Relevant Context
All the scripts to extract relevant context can be found under `./extract_context/` directory.

### 1.1. Extract list of instructions and map instructions to relevant human written tests. 

Extract the list of instructions from the specifications document and generate a mapping between instructions and human written test files from the [wasm spec repo](https://github.com/WebAssembly/spec/tree/main/test/core).
```
python3 main_extract_instruction_test_map.py
```

### 1.2. Extract constraints
Extract all the relevant constraints for each instruction from the [WASM specifications document](https://webassembly.github.io/spec/core/).
```
python3 main_extract_constraints.py
```

### 1.3. Extract relevant context from code
For a given implementation, extract the relevant code snippet from the source code files for each instruction. Then generate a list of differences (described in natural language) between the extracted code snippets.
```
python3 main_extract_code_diffs.py
```

### 1.4. Preprocess human written tests

The human written test files have several test cases in each file for a given instruction. We preprocess these files to only keep the test cases relevant to validation and separate them by creating a new file for each test case.
```
python3 main_separate_human_tests.py
```

## 2. Test Generation
The test generation framework includes two main steps.

### 2.1 Generate test descriptions
First, we use all the extracted information as context to prompt the LLM to generate descriptions of what each test should do.
```
python3 main_test_decription_generation.py
```

### 2.2 Generate tests from descriptions
We then use the test descriptions along with few randomly sampled human written tests, as few shot examples, and a list of human written guidelines to generate the tests themselves.
```
python3 main_test_generation.py
```

## 3. Utils
The data loaders and other data specific utilities are in `/utils/data_utils.py`

The model specific utilities are in `/utils/model_utils.py`

All the prompts are in `/utils/prompt_utils.py`

## 4. Evaluation

### 4.1. Setup instructions for each WASM implementation
We setup the four different WASM implementations by following the guidelines in the respective repositories.
- [WASM Spec implementation](https://github.com/WebAssembly/spec)
- [Wizard Engine](https://github.com/titzer/wizard-engine)
- [wasmtime](https://github.com/bytecodealliance/wasmtime)
- [v8](https://chromium.googlesource.com/v8/v8.git) 

### 4.2. Remove assert strings from generated tests
We remove the assert strings generated by the LLM as the expected output since <TODO>.

```
python3 remove_assert_str.py
```

### 4.3. Convert .wast test files into suitable format for execution
We convert the generated `.wast` test files into the format suitable for execution for each of the implementations.

wizard-engine, wasmtime and WASM spec use the `.bin.wast` format
```
<TODO>
```

v8 uses `.js` format
```
<TODO>
```


### 4.4. Run tests
We then run the tests on all the different implementations under test and compare them against the WASM spec implementation.
- wizard-engine
```
```

- wasmtime
```
```

- v8
```
```

### 4.5. Get Differentiating tests
We take the logs from running the tests for each implementation and compare the execution output against the WASM spec implementation, and we extract all the tests where the outcomes of the two implementations are different. This produces `.json` file comprising of all the information relevant to the differentiating tests, including the test file meta data, test content and the execution outcome of the WASM spec and the implementation under test, aiding in analysis of tests which highlight differentiating behaviour.
```
python3 get_diff_tests.py
```

## Misc

* `/context/` has all the relevant context including the source code files, extracted constraints, bug classes and their descriptions, extracted code context (includes relevant code snippets for instruction, and list of differences between the implementations), and the generated test descriptions.  

* `/human_written_tests/WebAssembly/processed_control_flow_validation/` has both the relevant human written test files as well as the processed tests files (See [section 1.4](#14-preprocess-human-written-tests)).


## References
- [WASM Specifications document](https://webassembly.github.io/spec/core/)
- [WASM Spec implementation](https://github.com/WebAssembly/spec)
- [Wizard Engine](https://github.com/titzer/wizard-engine)
- [wasmtime](https://github.com/bytecodealliance/wasmtime)
- [v8](https://chromium.googlesource.com/v8/v8.git) 